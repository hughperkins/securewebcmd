<html>
<head>
<meta http-equiv="cache-control" content="no-cache" />
<meta charset="utf-8" />
<script src="jquery-1.11.2.min.js"></script>
<script src="md5.min.js"></script>
<style>
</style>
<script>
function tail( id ) {
    $('#myiframe').attr('src','/job?jobId=' + id);
}
function kill( id ) {
    $.post('/kill', {'id': id }, function( response ) {
        console.log( response );
        console.log( response.result );
    });
}
function refreshJobs() {
    $.get( '/jobs', {}, function( response ) {
        //console.log( response );
        var jobs = JSON.parse( response );
        console.log( jobs.length );
        var newHtml = '';
        for( var i = 0; i < jobs.length; i++ ) {
            var job = jobs[i];
            newHtml += jobToHtml( job ) + '<br />';
        }
        $('#jobs').html(newHtml);
    });
}
function jobToHtml( job ) {
    console.log( job );
    var argsstring = '';
    if( typeof job.args != 'undefined' ) {
        argsstring = '' + job.args;
    }
    var jobhtml = job.id + ' ' + job.cmd + ' ' + argsstring;
    //jobhtml += ' ' + job.done;
    if( !job.done ) { 
        jobhtml += '&nbsp;&nbsp;&nbsp;<input type="button" class="tail" value="tail" onclick="tail(' + job.id + ');" />';
        jobhtml += '<input type="button" class="kill" value="kill" onclick="kill(' + job.id + ');" />';
    } else {
        jobhtml += '&nbsp;&nbsp;&nbsp;<input type="button" class="tail" value="results" onclick="tail(' + job.id + ');" />';
    }
    return jobhtml;
}
function addJobToHtml( job ) {
    $('#jobs').append( jobToHtml(job) + '<br />' );
}
$( function() {
    var oldLength = 0;
    var oldText = '';
    window.setInterval( function() {
        var newText = $('#myiframe').contents().text();
        //if( newText.length == oldLength ) {
        if( newText == oldText ) {
            return;
        }
        $('#outputdiv').html(newText.replace(/ /g, '&nbsp;').replace(/\n/g, '<br />\n'));
        oldLength = newText.length;
        oldText = newText;
        //console.log($('#myiframe').contents().text() );
        refreshJobs();
    }, 3000 );
    $('#go').click( function( event ) {
        //alert('hey!');
        var passwordValue = $('#password').val();
        var dirValue = $('#dir').val();
        var cmdValue = $('#cmd').val();
        var stringToCheck = passwordValue + '||' + dirValue + '||' + cmdValue;
        console.log(stringToCheck);
        var checksum = md5( stringToCheck );
        console.log(checksum);
        var urlpath = '/run2?dir=' + dirValue + '&cmd=' + cmdValue + '&check=' + checksum;
        console.log( urlpath );

        //$.post('/

        //$('#myiframe').attr('src','/run2?cmd=ls');
        //$('#myiframe').attr('src',urlpath);
        $.post('/run2', { 'dir': dirValue, 'cmd': cmdValue, 'check': checksum }, function( response ) {
            //console.log( 'response: ' + response );
            var job = response;
            console.log(job);
            console.log(job.result );
            if( job.result == 'success' ) {
                console.log( response );
                console.log( response.id );
                addJobToHtml( job );
                tail( response.id );
            } else {
                alert(job.error);
            }
        }, 'json' );
        //$.ajax( {
        //    url: "/run2",
        //    data: { 'dir': dirValue, 'cmd': cmdValue, 'check': checksum },
        //    dataFilter: function( data, type ) {
        //        console.log('datafilter called');
        //        console.log('data: ' + data );
        //    },
        //    success: function(response) {
        //        console.log(response);
        //    }
        //});
    });
    refreshJobs();
});
</script>
</head>
<body>
<input type="button" onclick="refreshJobs();" value="refresh jobs" /><br />
<div id="jobs"></div>
Password: <input type="password" id="password" /><br />
Directory: <input type="text" size="40" name="dir" id="dir" value="." /><br />
Cmd: <input type="text" size="100" name="cmd" id="cmd" value="" /><br />
<input type="button" id="go" value="run" /><br />
<br />
<div id="outputdiv"></div>
<iframe height="450" width="1024" id="myiframe" style='display: none'></iframe>
</body>
</html>

