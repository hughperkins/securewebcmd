<html>
<head>
<meta http-equiv="cache-control" content="no-cache" />
<meta charset="utf-8" />
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script src="jquery/jquery.min.js"></script>
<script src="md5/md5.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="angular/angular.min.js"></script>
<style>
</style>
<script>
function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min)) + min;
}
function getSaltedPassword() {
    var password = $('#password').val();
    var salt = getRandomInt(0,100000000);
    var saltedPass = salt + '|' + md5( salt + '|' + password );
    //console.log( saltedPass );
    return saltedPass;
}
function hashPassword(password) {
    if( typeof password == 'undefined' ) {
        password = '';
    }
    var salt = getRandomInt(0,100000000);
    var saltedPass = salt + '|' + md5( salt + '|' + password );
    return saltedPass;
}

function getJobIndex( jobs, jobId ) {
    for( var i in jobs ) {
        if( jobs[i].id == jobId ) {
            return i;
        }
    }
    return -1;
}

var oldLength = 0;
var oldText = '';
$( function() {
});

var app = angular.module('mainapp', [] );
app.controller( 'maincontroller', function( $scope, $http ) {
    $scope.refreshJobs = function() {
        var data = { 'checkpass': hashPassword( $scope.password ) };
        $http.post('/jobs', data ).success( function( data ) {
            for( var i in data ) {
                if( typeof data[i].args != 'undefined' ) {
                    data[i].joinedargs = data[i].args.join(' ');
                } else {
                    data[i].joinedargs = '';
                }
            }
            $scope.jobs = data;
        });
    }
    $scope.launch = function() {
        if( typeof $scope.cmd == 'undefined' || $scope.cmd == '' ) {
            alert('Please provide a command, and try again');
            return;
        }
        var stringToCheck = ( $scope.password || '' ) + '||' + $scope.dir + '||' + $scope.cmd;
        console.log(stringToCheck);
        var checksum = md5( stringToCheck );
        console.log(checksum);

        var data = { 'dir': $scope.dir, 'cmd': $scope.cmd, 'check': checksum };
        console.log('submitting:', data );
        $http.post('/run2', data ).success( function( data ) {
            var job = data;
            console.log(job);
            if( typeof job.args != 'undefined' ) {
                job.joinedargs = job.args.join(' ');
            } else {
                job.joinedargs = '';
            }
            $scope.jobs.push(job);
            $scope.tail( job );
            console.log('finished calling run2');
        });
    }
    $scope.tail = function( job ) {
        console.log('tailing:', job );
        $('#myiframe').attr('src','/job?jobId=' + job.id + '&checkpass=' + hashPassword($scope.password) + '&nocompress=1' );
       // $scope.iframesrc = '/job?jobId=' + job.id + '&checkpass=' + hashPassword($scope.password);
    }
    $scope.copyArgs = function( job ) {
        console.log( 'copyargs ', job );
        $scope.dir = job.dir;
        $scope.cmd = job.cmd + ' ' + job.joinedargs; 
    }
    $scope.remove = function( job ) {
        $http.post('/remove', { 'checkpass': hashPassword($scope.password), 'id': job.id } ).success( function( data ) {
            var index = getJobIndex( $scope.jobs, job.id );
            $scope.jobs.splice( index, 1 );
        });
    }
    $scope.kill = function( job ) {
        $http.post('/kill', { 'checkpass': hashPassword($scope.password), 'id': job.id } ).success( function( data ) {
            job.done = true;
            job.state = 'done';
        });
    }
    $scope.refreshOutput = function() {
        console.log('$scope.refreshOutput()');
        var newText = $('#myiframe').contents().text();
        if( newText == oldText ) {
            console.log('refreshoutput: no change => exiting');
            return;
        }
        $('#outputdiv').html(newText.replace(/ /g, '&nbsp;').replace(/\n/g, '<br />\n'));
        oldLength = newText.length;
        oldText = newText;
        //$scope.refreshJobs();
        console.log('exiting refreshoutput');
    }
    window.setInterval( function() {
        console.log('set interval start');
        $scope.refreshOutput();
        console.log('set interval end');
    }, 3000 );
    $('#myiframe').load( function( event ) {
        console.log('iframe load start');
        $scope.refreshOutput();
        console.log('iframe load end');
    });
    $scope.refreshJobs();
});
</script>
</head>
<body>
<div class="container" ng-app="mainapp" ng-controller="maincontroller">
    <h1>Launch</h1>
    <br />
    <br />
    <form class="form-horizontal">
        <div class="form-group">
            <label for="password" class="control-label col-xs-2">Password</label> 
            <div class="col-xs-10">
             <input type="password" ng-model="password" class="form-control" placeholder="password" id="password" />
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-xs-2">Directory</label>
            <div class="col-xs-10">
                <input type="text" ng-model="dir" class="form-control col-xs-10" name="dir" placeholder="working directory" id="dir" placeholder="working directory" />
            </div>
        </div>
        <div class="form-group">
            <label class="control-label col-xs-2">Cmd</label>
            <div class=" col-xs-10">
                <input type="text" ng-model="cmd" class="form-control" name="cmd" placeholder="command to run" id="cmd" value="" />
            </div>
        </div>
        <div class="form-group">
            <div class="col-xs-2 col-xs-offset-2">
                <button class="btn btn-primary" ng-click="launch()" id="go">Launch <span class="glyphicon glyphicon-play" /></button>
            </div>
        </div>
    </form>
    <br />
    <h1>History</h1>
    <br />
    <button class="btn btn-default" ng-click="refreshJobs()">Refresh <span class="glyphicon glyphicon-refresh" ></span></button><br />
    <br />
    <div id="jobs">
        <table class="table">
        <tr><th>Id</th><th>Command<th>State<th>Actions</tr>
        <tr ng-repeat="job in jobs | orderBy:'id'" >
            <td>{{job.id}}</td>
            <td>{{job.cmd}} {{job.joinedargs}}</td>
            <td>{{job.state}}</td>
            <td><button class="btn btn-default" ng-click="tail( job )">Results</button>
            <button class="btn btn-default" ng-click="copyArgs( job )">Copy</button>
            <button class="btn btn-danger" ng-click="kill( job )" ng-hide="job.done == true">Kill</button>
            <button class="btn btn-danger" ng-click="remove( job )" ng-hide="job.done != true">Remove</button>
        </tr>
        </table>
    </div>
    <h1>Results</h1>
    <div id="outputdiv">
    </div>
</div>
<iframe height="450" width="1024" id="myiframe" style='display: none'>
</iframe>
</body>
</html>

