<html>
<head>
<meta http-equiv="cache-control" content="no-cache" />
<meta charset="utf-8" />
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
<script src="jquery/jquery.min.js"></script>
<script src="md5/md5.min.js"></script>
<script src="bootstrap/js/bootstrap.min.js"></script>
<script src="angular/angular.min.js"></script>
<style>
</style>
<script>
function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min)) + min;
}
function tail( id ) {
    $('#myiframe').attr('src','/job?jobId=' + id + '&checkpass=' + getSaltedPassword());
}
function kill( id ) {
    $.post('/kill', {'id': id, 'checkpass': getSaltedPassword() }, function( response ) {
        console.log( response );
        console.log( response.result );
    });
}
function copyArgs( dir, cmd ) {
    console.log( 'copyargs ' + dir + ' ' + cmd );
    $('#dir').val(dir);
    $('#cmd').val(cmd); 
}
function getSaltedPassword() {
    var password = $('#password').val();
    var salt = getRandomInt(0,100000000);
    var saltedPass = salt + '|' + md5( salt + '|' + password );
    //console.log( saltedPass );
    return saltedPass;
}
function hashPassword(password) {
    if( typeof password == 'undefined' ) {
        password = '';
    }
    var salt = getRandomInt(0,100000000);
    var saltedPass = salt + '|' + md5( salt + '|' + password );
    return saltedPass;
}
function refreshJobs_() {
    $.get( '/jobs', {'checkpass': getSaltedPassword()}, function( response ) {
        var jobs = response;
        //console.log( jobs.length );
        var newHtml = '';
        for( var i = 0; i < jobs.length; i++ ) {
            var job = jobs[i];
            newHtml += jobToHtml( job ) + '<br />';
        }
        $('#jobs').html(newHtml);
    });
}
function jobToHtml( job ) {
    //console.log( job );
    //console.log( 'job dir: ' + job.dir );
    //console.log( 'job cmd: ' + job.cmd );
    var argsstring = '';
    if( typeof job.args != 'undefined' ) {
        argsstring = '' + job.args.join(' ');
    }
    var fullcmd = job.cmd;
    if( argsstring != '' ) {
        fullcmd += ' ' + argsstring;
    }
    var jobhtml = job.id + ' ' + job.cmd + ' ' + argsstring + ' ' + job.state;
    //jobhtml += ' ' + job.done;
    if( job.state == 'running' ) { 
        jobhtml += '&nbsp;&nbsp;&nbsp;<input type="button" class="tail" value="tail" onclick="tail(' + job.id + ');" />';
        jobhtml += '<input type="button" class="kill" value="kill" onclick="kill(' + job.id + ');" />';
    } else if ( job.state == 'done' ) {
        jobhtml += '&nbsp;&nbsp;&nbsp;<input type="button" class="tail" value="results" onclick="tail(' + job.id + ');" />';
    } else { // queued
        jobhtml += '&nbsp;&nbsp;&nbsp;<input type="button" class="tail" value="tail" onclick="tail(' + job.id + ');" />';
    }
    jobhtml += '<input type="button" class="copyargs" value="copy values" onclick="copyArgs(\'' + job.dir + '\',\'' + fullcmd + '\');" />';
    //console.log( jobhtml );
    return jobhtml;
}
var oldLength = 0;
var oldText = '';
function refreshOutput() {
    var newText = $('#myiframe').contents().text();
    if( newText == oldText ) {
        return;
    }
    $('#outputdiv').html(newText.replace(/ /g, '&nbsp;').replace(/\n/g, '<br />\n'));
    oldLength = newText.length;
    oldText = newText;
    refreshJobs();
}
function addJobToHtml( job ) {
    $('#jobs').append( jobToHtml(job) + '<br />' );
}
$( function() {
    window.setInterval( function() {
        refreshOutput();
    }, 3000 );
    $('#go').click( function( event ) {
        var passwordValue = $('#password').val();
        var dirValue = $('#dir').val();
        var cmdValue = $('#cmd').val();
        var stringToCheck = passwordValue + '||' + dirValue + '||' + cmdValue;
        //console.log(stringToCheck);
        var checksum = md5( stringToCheck );
        //console.log(checksum);
        var urlpath = '/run2?dir=' + dirValue + '&cmd=' + cmdValue + '&check=' + checksum;
        //console.log( urlpath );

        $.post('/run2', { 'dir': dirValue, 'cmd': cmdValue, 'check': checksum }, function( response ) {
            var job = response;
            //console.log(job);
            //console.log(job.result );
            if( job.result == 'success' ) {
                //console.log( response );
                //console.log( response.id );
                addJobToHtml( job );
                tail( response.id );
            } else {
                alert(job.error);
            }
        }, 'json' );
    });
    $('#myiframe').load( function( event ) {
        console.log('iframe load');
        refreshOutput();
    });
    //refreshJobs();
});

var app = angular.module('mainapp', [] );
/*app.controller( 'maincontroller', [
    '$scope',
    function( $scope ) {
        console.log('$scope function');
        $scope.refreshJobs = function() {
            console.log('clicked $scope.refreshJobs');
        }
    }
]);*/
app.controller( 'maincontroller', function( $scope, $http ) {
    $scope.refreshJobs = function() {
        var data = { 'checkpass': hashPassword( $scope.password ) };
        $http.post('/jobs', data ).success( function( data ) {
            for( var i in data ) {
                if( typeof data[i].args != 'undefined' ) {
                    data[i].joinedargs = data[i].args.join(' ');
                } else {
                    data[i].joinedargs = '';
                }
            }
            $scope.jobs = data;
        });
    }
    $scope.refreshJobs();
});
</script>
</head>
<body>
<div class="container" ng-app="mainapp" ng-controller="maincontroller">
<h1>Launch</h1>
<br />
<br />
<form class="form-horizontal">
    <div class="form-group">
        <label for="password" class="control-label col-xs-2">Password</label> 
        <div class="col-xs-10">
         <input type="password" ng-model="password" class="form-control" placeholder="password" id="password" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-xs-2">Directory</label>
        <div class="col-xs-10">
            <input type="text" class="form-control col-xs-10" name="dir" placeholder="working directory" id="dir" placeholder="working directory" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label col-xs-2">Cmd</label>
        <div class=" col-xs-10">
            <input type="text" size="100" class="form-control" name="cmd" placeholder="command to run" id="cmd" value="" />
        </div>
    </div>
    <div class="form-group">
        <div class="col-xs-2 col-xs-offset-2">
            <button class="btn btn-primary" id="go">Launch <span class="glyphicon glyphicon-play" /></button>
        </div>
    </div>
</form>
<br />
<div id="outputdiv"></div>
<h1>History</h1>
<br />
<button class="btn btn-default" ng-click="refreshJobs()">Refresh <span class="glyphicon glyphicon-refresh" ></span></button><br />
<br />
<div id="jobs">
<table class="table">
<tr><th>Id</th><th>Command<th>State</tr>
<tr ng-repeat="job in jobs | orderBy:'-id'" >
<td>{{job.id}}</td><td>{{job.cmd}} {{job.joinedargs}}</td><td>{{job.state}}</td>
</tr>
</table>
</div>
</div>
<iframe height="450" width="1024" id="myiframe" style='display: none'></iframe>
</body>
</html>

